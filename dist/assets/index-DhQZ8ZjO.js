(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function e(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=e(r);fetch(r.href,a)}})();class w{baseUrl;options;constructor(t,e={}){this.baseUrl=t,this.options={headers:{"Content-Type":"application/json",...e.headers??{}}}}handleResponse(t){return t.ok?t.json():t.json().then(e=>Promise.reject(e.error??t.statusText))}get(t){return fetch(this.baseUrl+t,{...this.options,method:"GET"}).then(this.handleResponse)}post(t,e,n="POST"){return fetch(this.baseUrl+t,{...this.options,method:n,body:JSON.stringify(e)}).then(this.handleResponse)}}const L="https://larek-api.nomoreparties.co/api/weblarek",C={"софт-скил":"card__category_soft","хард-скил":"card__category_hard",кнопка:"card__category_button",дополнительное:"card__category_additional",другое:"card__category_other"};class x{api;constructor(t){this.api=t}async getProducts(){return this.api.get("/product/")}async postOrder(t){return this.api.post("/order/",t)}}class B{constructor(t){this.eventEmitter=t}products=[];selectedProduct=null;setItems(t){this.products=t}getItems(){return[...this.products]}getItemById(t){const e=this.products.find(n=>n.id===t);if(!e)throw new Error("Товар не найден");return e}setSelectedItem(t){this.selectedProduct=t,this.getSelectedItem()&&this.eventEmitter.emit("preview")}getSelectedItem(){return this.selectedProduct?{...this.selectedProduct}:null}}class P{constructor(t){this.eventEmitter=t}cartItems=[];getItems(){return[...this.cartItems]}addItem(t){this.isInCart(t.id)||(this.cartItems.push(t),this.eventEmitter.emit("cart:changed"))}removeItem(t){this.cartItems=this.cartItems.filter(e=>e.id!==t),this.eventEmitter.emit("cart:changed")}clearCart(){this.cartItems=[],this.eventEmitter.emit("cart:changed")}totalPrice(){return this.cartItems.reduce((t,e)=>t+Number(e.price),0)}totalItems(){return this.cartItems.length}isInCart(t){return this.cartItems.some(e=>e.id===t)}}class S{payment="";address="";phone="";email="";constructor(){}setInfo(t){t.payment!==void 0&&(this.payment=t.payment),t.address!==void 0&&(this.address=t.address),t.phone!==void 0&&(this.phone=t.phone),t.email!==void 0&&(this.email=t.email)}getInfo(){return{payment:this.payment,address:this.address,phone:this.phone,email:this.email}}clearInfo(){this.payment="",this.address="",this.phone="",this.email=""}validateInfo(){let t={};const e=this.getInfo();return e.payment===""&&(t.payment="Не выбран вид оплаты"),e.address===""&&(t.address="Укажите адрес"),e.phone===""&&(t.phone="Укажите номер телефона"),e.email===""&&(t.email="Укажите емэйл"),t}}class l{constructor(t){this.container=t}setImage(t,e,n){t&&(t.src=e,n&&(t.alt=n))}render(t){return Object.assign(this,t??{}),this.container}}function _(s){return typeof s=="string"&&s.length>1}function T(s,t=document){if(_(s))return Array.from(t.querySelectorAll(s));if(s instanceof NodeList)return Array.from(s);if(Array.isArray(s))return s;throw new Error("Unknown selector element")}function o(s,t){if(_(s)){const e=T(s,t);if(e.length>1&&console.warn(`selector ${s} return more then one element`),e.length===0)throw new Error(`selector ${s} return nothing`);return e.pop()}if(s instanceof HTMLElement)return s;throw new Error("Unknown selector element")}function d(s){const t=o(s);if(!t.content.firstElementChild)throw new Error(`Template ${s} has no content`);return t.content.firstElementChild.cloneNode(!0)}class O extends l{constructor(t,e){super(e),this.eventEmmiter=t,this.basketButton=o(".header__basket",this.container),this.counterElement=o(".header__basket-counter",this.container),this.basketButton.addEventListener("click",this.eventEmmiter.trigger("basket"))}basketButton;counterElement;set counter(t){this.counterElement.textContent=String(t)}}class A extends l{catalogElement;constructor(t){super(t),this.catalogElement=d("#card-catalog")}set catalog(t){this.container.replaceChildren(...t)}}class f extends l{constructor(t,e){super(t),this.eventEmmiter=e,this.modalCloseButton=o(".modal__close",this.container),this.modalContent=o(".modal__content",this.container),this.modalCloseButton.addEventListener("click",this.eventEmmiter.trigger("modal:close")),this.container.addEventListener("click",n=>{n.target===n.currentTarget&&this.eventEmmiter.emit("modal:close")})}modalCloseButton;modalContent;static instance;static getInstance(t,e){return this.instance||(this.instance=new f(t,e)),this.instance}get content(){return this.modalContent}set content(t){this.modalContent.replaceChildren(t)}open(){this.container.classList.add("modal_active")}close(){this.container.classList.remove("modal_active")}}class b extends l{constructor(t,e){super(t),this.eventEmmiter=e,this.basketList=o(".basket__list",this.container),this.basketPrice=o(".basket__price",this.container),this.basketButton=o(".basket__button",this.container),this.basketButton.addEventListener("click",this.eventEmmiter.trigger("order"))}basketList;basketPrice;basketButton;static instance;static getInstance(t,e){return this.instance||(this.instance=new b(t,e)),this.instance}get element(){return this.container}set content(t){this.basketList.replaceChildren(...t)}set totalPrice(t){this.basketPrice.textContent=`${t} синапсов`}setButtonState(t){this.basketButton.disabled=!t}set orderButton(t){this.basketButton.disabled=!t}}class I extends l{cardTitle;cardPrice;constructor(t){super(t),this.cardTitle=o(".card__title",this.container),this.cardPrice=o(".card__price",this.container)}set title(t){this.cardTitle.textContent=t}set price(t){this.cardPrice.textContent=String(t||"Бесценно")}getTemplate(){return this.container}}function y(s,t){Object.values(C).forEach(e=>s.classList.remove(e)),s.classList.add(C[t])}class M extends I{cardImage;cardCategory;cardText;cardButton;constructor(t,e){super(t),this.cardImage=o(".card__image",this.container),this.cardCategory=o(".card__category",this.container),this.cardText=o(".card__text",this.container),this.cardButton=o(".card__button",this.container),e?.onClick&&this.cardButton.addEventListener("click",e.onClick)}set image(t){this.setImage(this.cardImage,t)}set category(t){this.cardCategory.textContent=t,y(this.cardCategory,t)}set description(t){this.cardText.textContent=t}set button(t){Object.assign(this.cardButton,t)}}class j extends I{basketIndex;basketDeleteButton;constructor(t,e){super(t),this.basketIndex=o(".basket__item-index",this.container),this.basketDeleteButton=o(".card__button",this.container),e?.onClick&&this.basketDeleteButton.addEventListener("click",e.onClick)}set index(t){this.basketIndex.textContent=String(t)}}class F extends l{constructor(t,e){super(t),this.eventEmmiter=e,this.totalPrice=o(".order-success__description",this.container),this.successButton=o(".order-success__close",this.container),this.successButton.addEventListener("click",this.eventEmmiter.trigger("modal:close"))}totalPrice;successButton;set total(t){this.totalPrice.textContent=String(t)}}class U extends I{cardCategory;cardImage;constructor(t,e){super(t),this.cardCategory=o(".card__category",this.container),this.cardImage=o(".card__image",this.container),e?.onClick&&this.container.addEventListener("click",e.onClick)}set category(t){this.cardCategory.textContent=t,y(this.cardCategory,t)}set image(t){this.setImage(this.cardImage,t)}}class D{_events;constructor(){this._events=new Map}on(t,e){this._events.has(t)||this._events.set(t,new Set),this._events.get(t)?.add(e)}off(t,e){this._events.has(t)&&(this._events.get(t).delete(e),this._events.get(t)?.size===0&&this._events.delete(t))}emit(t,e){this._events.forEach((n,r)=>{r==="*"&&n.forEach(a=>a({eventName:t,data:e})),(r instanceof RegExp&&r.test(t)||r===t)&&n.forEach(a=>a(e))})}onAll(t){this.on("*",t)}offAll(){this._events=new Map}trigger(t,e){return(n={})=>{this.emit(t,{...n||{},...e||{}})}}}class E extends l{submitButton;errorField;constructor(t){super(t),this.submitButton=o("[type=submit]",this.container),this.errorField=o(".form__errors",this.container)}get element(){return this.container}setSubmitEnable(t){this.submitButton.disabled=!t}}const H=s=>s==="card"||s==="cash"||s==="",p="button_alt-active";class R extends E{paymentTypes;address;constructor(t,e){super(t),this.address=o("input[name=address]",this.container),this.paymentTypes=o(".order__buttons",this.container),this.paymentTypes.addEventListener("click",n=>{if(!(n.target instanceof HTMLButtonElement))return;const r=n.target.name;H(r)&&([...this.paymentTypes.children].forEach(a=>{a!==n.target&&a.classList.remove(p)}),n.target.classList.toggle(p),e.onClick({payment:n.target.classList.contains(p)?r:""}))}),this.address.addEventListener("input",()=>{e.onInput({address:this.address.value})}),this.container.addEventListener("submit",n=>{n.preventDefault(),e.onSubmit()})}setErrors=t=>{this.errorField.textContent=t.join(" • "),this.setSubmitEnable(!t.length)}}class ${constructor(t,e,n){this.customer=e,this.eventEmmiter=n,this.form=new R(t,{onClick:this.onChange,onInput:this.onChange,onSubmit:this.onSubmit})}form;onChange=t=>{this.customer.setInfo(t);const{payment:e,address:n}=this.customer.validateInfo(),r=[e,n].filter(a=>!!a);this.form.setErrors(r)};onSubmit=()=>{this.eventEmmiter.emit("contacts")}}class G extends E{email;phone;constructor(t,e){super(t),this.email=o("input[name=email]",this.container),this.phone=o("input[name=phone]",this.container),this.email.addEventListener("input",n=>{n.target instanceof HTMLInputElement&&e.onInput({email:n.target.value})}),this.phone.addEventListener("input",n=>{n.target instanceof HTMLInputElement&&e.onInput({phone:n.target.value})}),this.container.addEventListener("submit",n=>{n.preventDefault(),e.onSubmit()})}setErrors=t=>{this.errorField.textContent=t.join(" • "),this.setSubmitEnable(!t.length)}}class q{constructor(t,e,n){this.customer=e,this.eventEmmiter=n,this.form=new G(t,{onInput:this.onChange,onSubmit:this.onSubmit})}form;onChange=t=>{this.customer.setInfo(t);const{email:e,phone:n}=this.customer.validateInfo(),r=[e,n].filter(a=>!!a);this.form.setErrors(r)};onSubmit=()=>this.eventEmmiter.emit("post")}const z=new w(L),k=new x(z);k.getProducts().then(s=>{h.setItems(s.items);const t=new A(o(".gallery")),n=h.getItems().map(r=>{const a=()=>{h.getItemById(r.id)&&h.setSelectedItem(r)};return new U(d("#card-catalog"),{onClick:a}).render(r)});t.render({catalog:n})}).catch(s=>{console.error(s)});const i=new D,h=new B(i),c=new P(i),m=new S,J=new O(i,o(".header")),v=f.getInstance(o("#modal-container"),i),g=b.getInstance(d("#basket"),i);function K(s){return s.map((t,e)=>{const n=i.trigger("card:remove",t);return new j(d("#card-basket"),{onClick:n}).render({...t,index:++e})})}function V(){const s=h.getSelectedItem();if(!s)return;const t=i.trigger("card:toggle",s),e=new M(d("#card-preview"),{onClick:t}),n=c.isInCart(s.id),r=!!s.price,a={textContent:n?"Удалить из корзины":r?"Купить":"Недоступно",disabled:!r};return e.render({...s,button:a})}i.on("modal",s=>{v.render({content:s.content}),i.emit("modal:open")});i.on("modal:open",()=>v.open());i.on("modal:close",()=>{h.setSelectedItem(null),v.close()});i.on("preview",()=>{i.emit("modal",{content:V()})});i.on("card:toggle",s=>{c.isInCart(s.id)?i.emit("card:remove",s):i.emit("card:add",s)});i.on("card:add",s=>{c.addItem(s)});i.on("card:remove",s=>{c.removeItem(s.id)});i.on("cart:changed",()=>{J.render({counter:c.totalItems()}),g.render({orderButton:c.totalItems()>0}),h.getSelectedItem()?i.emit("preview"):i.emit("basket")});i.on("basket",()=>{g.render({content:K(c.getItems()),orderButton:!!c.totalItems(),totalPrice:c.totalPrice()}),i.emit("modal",{content:g.element})});i.on("order",()=>{const{form:s}=new $(d("#order"),m,i);i.emit("modal",{content:s.element})});i.on("contacts",()=>{const{form:s}=new q(d("#contacts"),m,i);i.emit("modal",{content:s.element})});i.on("post",()=>{const s=c.getItems().map(e=>e.id),t=m.getInfo();k.postOrder({total:c.totalPrice(),items:s,...t}).then(e=>{const n=new F(d("#success"),i).render(e);i.emit("clear"),i.emit("modal",{content:n})}).catch(e=>{console.error(e)})});i.on("clear",()=>{c.clearCart(),m.clearInfo()});
